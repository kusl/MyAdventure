<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:MyAdventure.Shared.ViewModels"
        xmlns:conv="using:MyAdventure.Shared.Converters"
        xmlns:svc="using:MyAdventure.Shared.Services"
        x:Class="MyAdventure.Desktop.Views.MainWindow"
        x:DataType="vm:GameViewModel"
        Title="MyAdventure"
        Width="1100" Height="750"
        MinWidth="800" MinHeight="600"
        Background="#1A1A2E">

    <Window.Resources>
        <conv:HexToBrushConverter x:Key="HexToBrush" />
        <conv:BoolToOpacityConverter x:Key="BoolToOpacity" />
        <conv:PercentToFractionConverter x:Key="PercentToFraction" />
    </Window.Resources>

    <Panel>
        <DockPanel Margin="16">
            <!-- Top bar: Cash display + Angels + Prestige -->
            <Border DockPanel.Dock="Top" Background="#16213E" CornerRadius="12" Padding="20,12" Margin="0,0,0,12">
                <Grid ColumnDefinitions="*,Auto,Auto">
                    <!-- Cash -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                        <TextBlock Text="ðŸ’°" FontSize="32" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding CashText}" FontSize="36" FontWeight="Bold" 
                                   Foreground="#00E676" VerticalAlignment="Center" />
                    </StackPanel>
                    
                    <!-- Angels -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" Margin="20,0">
                        <TextBlock Text="ðŸ˜‡" FontSize="20" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding AngelText}" FontSize="18" Foreground="#FFD740" VerticalAlignment="Center" />
                        <TextBlock Text="{Binding AngelBonusText}" FontSize="14" Foreground="#FFD740" 
                                   Opacity="0.7" VerticalAlignment="Center" />
                    </StackPanel>
                    
                    <!-- Prestige -->
                    <StackPanel Grid.Column="2" Orientation="Vertical" Spacing="2" VerticalAlignment="Center">
                        <Button Command="{Binding PrestigeCommand}"
                                Background="#AA00FF" Foreground="White"
                                FontSize="16" FontWeight="Bold"
                                Padding="20,10" CornerRadius="8"
                                Opacity="{Binding CanPrestige, Converter={StaticResource BoolToOpacity}}">
                            <StackPanel Orientation="Horizontal" Spacing="6">
                                <TextBlock Text="ðŸ”„" VerticalAlignment="Center" />
                                <TextBlock Text="PRESTIGE" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding NextAngelText, StringFormat='+{0}'}" 
                                           FontSize="12" Opacity="0.8" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                        <TextBlock Text="{Binding PrestigeExplanation}" FontSize="10" 
                                   Foreground="#AAAAAA" HorizontalAlignment="Center"
                                   MaxWidth="300" TextWrapping="Wrap" TextAlignment="Center" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Business grid: 3 columns Ã— 2 rows -->
            <ItemsControl ItemsSource="{Binding Businesses}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Columns="3" Rows="2" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:BusinessViewModel">
                        <Border Background="#16213E" CornerRadius="12" Padding="12" Margin="6"
                                Opacity="{Binding Owned, Converter={StaticResource BoolToOpacity}, ConverterParameter=0}">
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,*">
                                <!-- Row 0: Icon + Name + Owned -->
                                <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,4">
                                    <TextBlock Grid.Column="0" Text="{Binding Icon}" FontSize="28" VerticalAlignment="Center" />
                                    <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="16" FontWeight="Bold" 
                                               Foreground="White" VerticalAlignment="Center" Margin="8,0,0,0" />
                                    <Border Grid.Column="2" Background="#0D47A1" CornerRadius="10" Padding="8,2">
                                        <TextBlock Text="{Binding Owned}" FontSize="14" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center" />
                                    </Border>
                                </Grid>

                                <!-- Row 1: Progress bar -->
                                <Grid Grid.Row="1" Margin="0,2,0,4">
                                    <Border Background="#0A0A1A" CornerRadius="4" Height="8" />
                                    <Border Background="{Binding Color, Converter={StaticResource HexToBrush}}" 
                                            CornerRadius="4" Height="8"
                                            HorizontalAlignment="Stretch"
                                            RenderTransformOrigin="0,0.5">
                                        <Border.RenderTransform>
                                            <ScaleTransform ScaleX="{Binding ProgressPercent, Converter={StaticResource PercentToFraction}, FallbackValue=0}" />
                                        </Border.RenderTransform>
                                    </Border>
                                </Grid>

                                <!-- Row 2: Revenue + Cost line -->
                                <Grid Grid.Row="2" ColumnDefinitions="*,*" Margin="0,0,0,4">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="ðŸ’µ" FontSize="11" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding RevenueText}" FontSize="12" 
                                                   Foreground="#00E676" VerticalAlignment="Center" />
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right">
                                        <TextBlock Text="ðŸ·ï¸" FontSize="11" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding CostText}" FontSize="12" 
                                                   Foreground="#FFAB40" VerticalAlignment="Center" />
                                    </StackPanel>
                                </Grid>

                                <!-- Row 3: Detail info panel (desktop has space) -->
                                <Border Grid.Row="3" Background="#0D1B2A" CornerRadius="6" Padding="8,4" Margin="0,0,0,4">
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto" ColumnDefinitions="*,*">
                                        <!-- Cycle time + Revenue/s -->
                                        <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="â±ï¸" FontSize="10" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding CycleTimeText}" FontSize="11" 
                                                       Foreground="#B0BEC5" VerticalAlignment="Center" />
                                        </StackPanel>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Spacing="4" HorizontalAlignment="Right">
                                            <TextBlock Text="ðŸ“ˆ" FontSize="10" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding RevenuePerSecondText}" FontSize="11" 
                                                       Foreground="#80CBC4" VerticalAlignment="Center" />
                                        </StackPanel>

                                        <!-- Affordable count -->
                                        <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                                                    Orientation="Horizontal" Spacing="4" Margin="0,2,0,0">
                                            <TextBlock Text="ðŸ›’" FontSize="10" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding AffordableCountText}" FontSize="11" 
                                                       Foreground="#CE93D8" VerticalAlignment="Center" />
                                        </StackPanel>

                                        <!-- Milestone multiplier -->
                                        <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" 
                                                    Orientation="Horizontal" Spacing="4" Margin="0,2,0,0">
                                            <TextBlock Text="â­" FontSize="10" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding MilestoneMultiplierText}" FontSize="11"
                                                       Foreground="#FFD740" VerticalAlignment="Center" />
                                            <TextBlock Text="multiplier" FontSize="10" 
                                                       Foreground="#666" VerticalAlignment="Center" />
                                        </StackPanel>

                                        <!-- Next milestone -->
                                        <StackPanel Grid.Row="3" Grid.Column="0" Grid.ColumnSpan="2" 
                                                    Orientation="Horizontal" Spacing="4" Margin="0,2,0,0"
                                                    IsVisible="{Binding HasNextMilestone}">
                                            <TextBlock Text="ðŸŽ¯" FontSize="10" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding NextMilestoneText}" FontSize="11"
                                                       Foreground="#90CAF9" VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding NextMilestoneRewardText}" FontSize="10"
                                                       Foreground="#A5D6A7" VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Grid>
                                </Border>

                                <!-- Row 4: Action buttons -->
                                <Grid Grid.Row="4" ColumnDefinitions="*,4,*,4,*" Margin="0,2,0,0">
                                    <!-- Buy button -->
                                    <Button Grid.Column="0" Command="{Binding BuyBusinessCommand}"
                                            Background="{Binding Color, Converter={StaticResource HexToBrush}}"
                                            Foreground="White" FontWeight="Bold" FontSize="13"
                                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                            Padding="0,8" CornerRadius="6"
                                            Opacity="{Binding CanAfford, Converter={StaticResource BoolToOpacity}}">
                                        <TextBlock Text="BUY" />
                                    </Button>
                                    
                                    <!-- Run button -->
                                    <Button Grid.Column="2" Command="{Binding ClickBusinessCommand}"
                                            Background="#2196F3" Foreground="White"
                                            FontWeight="Bold" FontSize="13"
                                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                            Padding="0,8" CornerRadius="6"
                                            Content="â–¶ RUN" />
                                    
                                    <!-- Manager button -->
                                    <Button Grid.Column="4" Command="{Binding BuyManagerCommand}"
                                            IsVisible="{Binding !HasManager}"
                                            Background="#FF6F00" Foreground="White"
                                            FontWeight="Bold" FontSize="13"
                                            HorizontalAlignment="Stretch" HorizontalContentAlignment="Center"
                                            Padding="0,8" CornerRadius="6"
                                            Opacity="{Binding CanAffordManager, Converter={StaticResource BoolToOpacity}}"
                                            Content="MGR" />
                                    <Border Grid.Column="4" IsVisible="{Binding HasManager}"
                                            Background="#2E7D32" CornerRadius="6" Padding="0,8"
                                            HorizontalAlignment="Stretch">
                                        <TextBlock Text="âœ… AUTO" HorizontalAlignment="Center"
                                                   Foreground="White" FontWeight="Bold" FontSize="13" />
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </DockPanel>

        <!-- Toast overlay: bottom center, auto-dismiss -->
        <ItemsControl ItemsSource="{Binding Toasts.ActiveToasts}"
                      HorizontalAlignment="Center" VerticalAlignment="Bottom"
                      Margin="0,0,0,24">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Spacing="6" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="svc:ToastItem">
                    <Border Background="#333333" CornerRadius="8" Padding="16,10"
                            MaxWidth="500" Opacity="0.95">
                        <TextBlock Text="{Binding Message}" Foreground="White" FontSize="14"
                                   TextWrapping="Wrap" TextAlignment="Center" />
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Panel>
</Window>
